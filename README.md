# 🛡️ Схема защиты сервера от DDoS-атак с ограниченными ресурсами для Linux/Unix систем и Windows.

**Многоуровневая архитектура фильтрации и защиты, реализуемая с минимальными затратами.**

**Схема: Интернет → Cloudflare → Фаервол → Балансировщик → Серверы → База данных → Мониторинг**

---

> 🧠 **Важно понимать**: ни одна схема не даёт 100% гарантии даже с дорогостоящим оборудованием, но многоуровневая архитектура должна быть как база, которая помогает отфильтровывать до 95% шумового и вредоносного трафика до того, как он дойдёт до сервера и приложений работающих на нем.

---
##  Для Linux/Unix систем (для Windows ниже)

## 🌐 1. Внешний уровень (Интернет)

**Облачный фильтр: Cloudflare (Free Tier)**  
- 🔒 SSL/TLS-шифрование  
- 🧱 Блокировка вредоносных IP и ботов  
- 🌍 Гео-фильтрация  
- 📦 Кэширование статики  

---

## 🧰 2. Первичная фильтрация (Выделенный сервер №1)

**🧱 Фаервол: iptables/nftables**  
- Ограничение соединений на IP  
- Блокировка подозрительных портов

**🔁 Nginx как Reverse Proxy**  
- Rate limiting  
- Slowloris protection  
- Фильтрация HTTP/HTTPS-запросов  

---

## ⚖️ 3. Балансировка нагрузки (Выделенный сервер №2)

**HAProxy / Keepalived**  
- 📡 Health-check'и  
- 🚦 Перераспределение трафика  
- ❌ Исключение перегруженных нод  

---

## 🖥️ 4. Серверы приложений

- **Fail2ban** — автоматическая блокировка IP  
- **ModSecurity** — фильтрация SQLi, XSS и др.  
- **Ограничения ресурсов** через systemd/docker  

---

## 🗄️ 5. База данных

- 🔐 Только внутренний доступ  
- 🔒 Закрытые внешние порты  
- 💾 Регулярное резервное копирование (`rsync`, `BorgBackup`)  

---

## 📊 6. Мониторинг и анализ

- **Prometheus + Grafana** — нагрузка и активность  
- **Elasticsearch + Kibana** — лог-анализ  
- **Telegram / Email уведомления** — при аномалиях  

---

## ➕ Дополнительные меры

- 🌍 Гео-блокировка через iptables  
- 🤖 Скрипты автоматической блокировки и защиты (fail2ban + анализ логов)  
- 🔄 Регулярное обновление ПО и патчей  
- 📶 Резервный канал связи  

## 🧩 Визуальная модель (схема уровней). Текстовая схема в виде ASCII-графики, которая визуализирует защиту от DDoS и фильтрацию трафика:

```
┌──────────────────────────────┐
│         Интернет             │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  Облачный фильтр             │
│  (Cloudflare Free Tier)      │
│  • Кэширование статики       │
│  • Блокировка ботов/IP       │
│  • Гео-фильтрация            │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  Выделенный сервер №1        │
│  • iptables/nftables         │  ← Блокировка портов
│  • Nginx (reverse proxy)     │  ← Rate Limiting
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  Выделенный сервер №2        │
│  • HAProxy/Keepalived        │  ← Балансировка
│  • Health Checks             │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  Серверы приложений          │
│  • Fail2ban                  │  ← Автоблокировка IP
│  • ModSecurity               │  ← Защита от SQLi/XSS
│  • Ограничения CPU/RAM       │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  База данных                 │
│  • Закрытые порты            │
│  • Резервные копии           │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  Мониторинг                  │
│  • Prometheus + Grafana      │  ← Метрики
│  • Elasticsearch + Kibana    │  ← Анализ логов
│  • Оповещения в Telegram     │
└──────────────────────────────┘
```

---
## Пояснения:
---
1. Стрелки (▼) показывают направление трафика.

2. Каждый блок — это этап фильтрации или обработки.

3. Серверы №1 и №2 разделены для распределения нагрузки (можно разместить на одной физической машине, если ресурсы ограничены).

4. Мониторинг — отдельный слой для анализа атак и быстрого реагирования.
---
## Как это работает:
---
1. Трафик сначала проходит через Cloudflare, где отсекается большая часть ботов и мусорных запросов.

2. На первом сервере фаервол блокирует ненужные порты, а Nginx ограничивает частоту запросов.

3. Балансировщик на втором сервере распределяет оставшийся "чистый" трафик между серверами приложений.

4. На серверах приложений Fail2ban и ModSecurity добавляют дополнительный уровень защиты.

5. База данных изолирована от прямого доступа извне.

6. Мониторинг отслеживает аномалии в режиме реального времени.
---

##  Для Windows 
**Впринципе схема и суть одинакова, только разные инструменты и ПО. Адаптированная схема защиты для сервера на Windows с IIS/Apache, учитывающая особенности ОС и доступные инструменты**

## 🧩 Визуальная модель (схема уровней). Текстовая схема в виде ASCII-графики, которая визуализирует защиту от DDoS и фильтрацию трафика:

```
┌──────────────────────────────┐
│         Интернет             │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  Облачный фильтр             │
│  (Cloudflare Free Tier)       │
│  • Кэширование статики       │
│  • Блокировка ботов/IP       │
│  • Гео-фильтрация            │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  Брандмауэр Windows          │
│  • Блокировка портов         │  ← Правила для RDP, SMB
│  • Ограничение соединений    │  ← PowerShell скрипты
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  Веб-сервер (IIS/Apache)     │
│  • Dynamic IP Restrictions   │  ← Лимит запросов с IP
│  • URL Rewrite Rules         │  ← Блокировка ботов
│  • ModSecurity (для Apache)  │  ← Защита от SQLi/XSS
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  Балансировка (опционально)  │
│  • IIS ARR (Application      │  ← Распределение нагрузки
│     Request Routing)         │
│  • HAProxy для Windows       │
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  Защита приложений           │
│  • Fail2Ban-аналоги:         │
│    - Windows IPSec           │  ← Автоблокировка через PowerShell
│    - CSF (для Apache)        │
│  • Защита от перегрузки:     │
│    - Ограничение в IIS       │  ← "Connection Limits"
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  База данных                 │
│  • Доступ только с сервера   │
│  • Брандмауэр БД             │  ← Правила для SQL Server
└──────────────┬───────────────┘
               ▼
┌──────────────────────────────┐
│  Мониторинг                  │
│  • Event Viewer + Logs       │  ← Анализ логов
│  • PRTG/Zabbix для Windows   │  ← Метрики сети
│  • Cloudflare Analytics      │  ← Отчеты об атаках
└──────────────────────────────┘
```

---
## Подробное описание для Windows/IIS:

## 1. Облачный фильтр (Cloudflare):

- Обязательно для защиты от объемных DDoS (Layer 3/4).

- Настройте SSL/TLS в режиме "Flexible" (если нет сертификата на сервере).

- Используйте Firewall Rules для блокировки:

```
(http.user_agent contains "BadBot") 
или 
(ip.src in {192.0.2.0/24 2001:db8::/32})
```

---

## 2. Брандмауэр Windows:

- Закройте ненужные порты (RDP, SMB для публичного доступа).

- Пример PowerShell для блокировки IP:

```
New-NetFirewallRule -DisplayName "Block DDoS IP" -Direction Inbound -RemoteAddress 123.45.67.89 -Action Block
```

- Используйте Windows Defender с включенной защитой от сетевых атак.

---

## 3. Веб-сервер (IIS):

**Dynamic IP Restrictions (встроено в IIS):**

- Лимит запросов: 20 запросов/сек с одного IP.

- Блокировка при превышении лимита.

**URL Rewrite Module для фильтрации:**
 
- Блокировка по User-Agent (например, *nmap*, *sqlmap*).

- Пример правила:

```
<rule name="Block Bad Bots">
  <match url=".*" />
  <conditions>
    <add input="{HTTP_USER_AGENT}" pattern="bot|crawler|spider" />
  </conditions>
  <action type="AbortRequest" />
</rule>
```
---
## 4. Apache на Windows (если используется):

- Установите ModSecurity и OWASP Core Rule Set.

- Настройте модуль mod_evasive для защиты от DDoS:
```
<IfModule mod_evasive24.c>
  DOSHashTableSize 3097
  DOSPageCount 2
  DOSSiteCount 50
  DOSPageInterval 1
  DOSSiteInterval 1
  DOSBlockingPeriod 3600
</IfModule>
```
---
## 5. Балансировка нагрузки:

- Для IIS: Application Request Routing (ARR) + Web Farm Framework.

- Для Apache: mod_proxy_balancer или HAProxy.

## 6. Автоматическая блокировка IP:

- PowerShell-скрипт на основе логов:

```
# Анализ логов IIS на предмет частых запросов
$logPath = "C:\inetpub\logs\LogFiles\W3SVC1\u_ex*.log"
$badIPs = Get-Content $logPath | Select-String -Pattern "POST /wp-login.php" | Group-Object -Property IP | Where-Object { $_.Count -gt 50 } | Select-Object -ExpandProperty Name
foreach ($ip in $badIPs) {
  New-NetFirewallRule -DisplayName "Block $ip" -Direction Inbound -RemoteAddress $ip -Action Block
}
```
---
## 7. База данных:

- Для SQL Server:

- Отключите доступ по SA.

- Используйте Windows Authentication.

- Настройте брандмауэр: только порт 1433 и только для IP веб-сервера.
---

## 8. Мониторинг:

- Event Viewer → Фильтруйте логи по кодам событий:

- 4625 (неудачные попытки входа).

- 5031 (перегрузка IIS).

- PRTG Network Monitor: отслеживание нагрузки на сеть и CPU.

---
##  Дополнительные меры:

- Обновления: Включите автоматическое обновление Windows + веб-сервера.

- Резервные копии: Используйте Veeam Agent или Windows Server Backup.

**RDP-защита:**

- Смените порт RDP с 3389 на случайный.

- Используйте VPN (например, OpenVPN) вместо прямого доступа к RDP.

**Антивирус: Windows Defender Advanced Threat Protection или Kaspersky Endpoint Security.

---
##  Важно:

- Если используется Apache, многие инструменты (например, ModSecurity) работают аналогично Linux.

- Для сложных атак (например, UDP-флуд) облачный фильтр обязателен, так как Windows-брандмауэр не справится с объемным трафиком.

- Регулярно проверяйте конфигурацию через Microsoft Baseline Security Analyzer (MBSA).
---
